import random
from bale import Bot, Message, MenuKeyboardButton, MenuKeyboardMarkup, InlineKeyboard, InlineKeyboardButton
import asyncio
import json
import os
from operator import itemgetter
from datetime import datetime, timedelta

# Persistent storage
DATA_FILE = "bot_data.json"

# Initialize or load data
if os.path.exists(DATA_FILE):
    with open(DATA_FILE, "r") as f:
        bot_data = json.load(f)
else:
    bot_data = {
        "chat_data": {},
        "points": {},
        "weapons_inventory": {},
        "diamond_mines": {},
        "last_diamond_collection": {},
        "resource_mines": {},
        "last_resource_collection": {},
        "battle_history": {},
        "superadmins": [],
        "user_info": {}  # Store user information
    }

# Ensure all required keys exist
required_keys = [
    "chat_data", "points", "weapons_inventory", "diamond_mines", 
    "last_diamond_collection", "resource_mines", "last_resource_collection",
    "battle_history", "user_info"
]
for key in required_keys:
    if key not in bot_data:
        bot_data[key] = {}

def save_data():
    with open(DATA_FILE, "w") as f:
        json.dump(bot_data, f, indent=2)

# Game Configuration
RESOURCE_TYPES = {
    "wood": {"name": "Ú†ÙˆØ¨", "emoji": "ğŸªµ", "price": 15},
    "coal": {"name": "Ø²ØºØ§Ù„ Ø³Ù†Ú¯", "emoji": "ğŸª¨", "price": 25},
    "iron": {"name": "Ø¢Ù‡Ù†", "emoji": "â›“ï¸", "price": 40}
}

WEAPONS_SHOP = {
    "soldier": {
        "name": "Ø³Ø±Ø¨Ø§Ø²",
        "price": 100,
        "resources": {"wood": 5},
        "description": "ÙˆØ§Ø­Ø¯ Ù¾ÛŒØ§Ø¯Ù‡ Ù†Ø¸Ø§Ù… Ù¾Ø§ÛŒÙ‡",
        "power": 10,
        "emoji": "ğŸª–",
        "loss_rate": 0.3
    },
    "tank": {
        "name": "ØªØ§Ù†Ú©",
        "price": 500,
        "resources": {"iron": 10, "coal": 5},
        "description": "ÙˆØ³ÛŒÙ„Ù‡ Ù†Ù‚Ù„ÛŒÙ‡ Ø²Ø±Ù‡ÛŒ Ø³Ù†Ú¯ÛŒÙ†",
        "power": 50,
        "emoji": "âš”ï¸",
        "loss_rate": 0.2
    },
    "fighter_jet": {
        "name": "Ø¬Ù†Ú¯Ù†Ø¯Ù‡ Ø§Ù-Û²Û²",
        "price": 2000,
        "resources": {"iron": 20, "coal": 10},
        "description": "Ø¬Ù†Ú¯Ù†Ø¯Ù‡ Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø¨Ø±ØªØ±ÛŒ Ù‡ÙˆØ§ÛŒÛŒ",
        "power": 200,
        "emoji": "âœˆï¸",
        "loss_rate": 0.15
    },
    "nuke": {
        "name": "Ø³Ù„Ø§Ø­ Ù‡Ø³ØªÙ‡ Ø§ÛŒ",
        "price": 10000,
        "resources": {"iron": 50, "coal": 30},
        "description": "Ù‚Ø¯Ø±Øª ØªØ®Ø±ÛŒØ¨ Ù†Ù‡Ø§ÛŒÛŒ",
        "power": 1000,
        "emoji": "â˜¢ï¸",
        "loss_rate": 0.1
    },
    "drone": {
        "name": "Ù¾Ù‡Ù¾Ø§Ø¯ Ø±Ø²Ù…ÛŒ",
        "price": 300,
        "resources": {"iron": 8, "coal": 3},
        "description": "ÙˆØ³ÛŒÙ„Ù‡ Ù†Ù‚Ù„ÛŒÙ‡ Ù‡ÙˆØ§ÛŒÛŒ Ø¨Ø¯ÙˆÙ† Ø³Ø±Ù†Ø´ÛŒÙ†",
        "power": 30,
        "emoji": "ğŸš",
        "loss_rate": 0.25
    },
    "battleship": {
        "name": "Ù†Ø§Ùˆ Ø¬Ù†Ú¯ÛŒ",
        "price": 3000,
        "resources": {"iron": 40, "wood": 20},
        "description": "Ú©Ø´ØªÛŒ Ø¬Ù†Ú¯ÛŒ Ø¨Ø§ ØªÙˆÙ¾ Ù‡Ø§ÛŒ Ø³Ù†Ú¯ÛŒÙ†",
        "power": 300,
        "emoji": "ğŸš¢",
        "loss_rate": 0.18
    },
    "su47": {
        "name": "Ø¬Ù†Ú¯Ù†Ø¯Ù‡ Ø³Ùˆ-Û´Û·",
        "price": 3500,
        "resources": {"iron": 25, "coal": 15},
        "description": "Ø¬Ù†Ú¯Ù†Ø¯Ù‡ Ø¢Ø²Ù…Ø§ÛŒØ´ÛŒ Ø±ÙˆØ³ÛŒ",
        "power": 450,
        "emoji": "ğŸ›©ï¸",
        "loss_rate": 0.12
    },
    "apache": {
        "name": "Ù‡Ù„ÛŒÚ©ÙˆÙ¾ØªØ± Ø¢Ù¾Ø§Ú†ÛŒ",
        "price": 1800,
        "resources": {"iron": 18, "coal": 8},
        "description": "Ù‡Ù„ÛŒÚ©ÙˆÙ¾ØªØ± Ù¾ÛŒØ´Ø±ÙØªÙ‡ ØªÙ‡Ø§Ø¬Ù…ÛŒ",
        "power": 280,
        "emoji": "ğŸš",
        "loss_rate": 0.2
    },
    "submarine": {
        "name": "Ø²ÛŒØ±Ø¯Ø±ÛŒØ§ÛŒÛŒ Ù‡Ø³ØªÙ‡ Ø§ÛŒ",
        "price": 4500,
        "resources": {"iron": 45, "coal": 25},
        "description": "Ú©Ø´ØªÛŒ Ø¬Ù†Ú¯ÛŒ Ø²ÛŒØ±Ø¢Ø¨ÛŒ Ù…Ø®ÙÛŒ",
        "power": 600,
        "emoji": "ğŸ›³ï¸",
        "loss_rate": 0.15
    }
}

DIAMOND_MINE_CONFIG = {
    "price": 5000,
    "production_rate": 30,  # Minutes
    "diamond_value": 1000,  # Points per diamond
    "starting_mines": 2
}

RESOURCE_MINE_CONFIG = {
    "wood": {
        "name": "Ú©Ø§Ø±Ø®Ø§Ù†Ù‡ Ú†ÙˆØ¨",
        "price": 1000,
        "production_rate": 45,  # Minutes
        "output": 10,  # Units per cycle
        "emoji": "ğŸªµ"
    },
    "coal": {
        "name": "Ù…Ø¹Ø¯Ù† Ø²ØºØ§Ù„ Ø³Ù†Ú¯",
        "price": 1500,
        "production_rate": 60,
        "output": 8,
        "emoji": "ğŸª¨"
    },
    "iron": {
        "name": "Ù…Ø¹Ø¯Ù† Ø¢Ù‡Ù†",
        "price": 2000,
        "production_rate": 75,
        "output": 5,
        "emoji": "â›“ï¸"
    }
}

BATTLE_CONFIG = {
    "min_reward": 500,
    "max_reward": 2000,
    "cooldown": 3600,  # 1 hour in seconds
    "min_power_diff": 0.2,
    "min_attack_power": 50
}

# Helper functions
def get_user_key(chat_id, user_id):
    return f"{chat_id}:{user_id}"

def update_user_info(user):
    """Store or update user information"""
    user_id = str(user.user_id)
    bot_data["user_info"][user_id] = {
        "username": user.username,
        "first_name": user.first_name,
        "last_name": user.last_name,
        "last_seen": datetime.now().isoformat()
    }
    save_data()

def get_user_name(user_id):
    """Get user's display name"""
    info = bot_data["user_info"].get(str(user_id), {})
    if info.get("username"):
        return f"@{info['username']}"
    return info.get("first_name", f"User {user_id}")

def award_points(chat_id, user_id, amount):
    key = get_user_key(chat_id, user_id)
    if key not in bot_data["points"]:
        bot_data["points"][key] = 0
    bot_data["points"][key] += amount
    save_data()
    return bot_data["points"][key]

def get_user_points(chat_id, user_id):
    key = get_user_key(chat_id, user_id)
    return bot_data["points"].get(key, 0)

def get_user_inventory(chat_id, user_id):
    key = get_user_key(chat_id, user_id)
    if key not in bot_data["weapons_inventory"]:
        bot_data["weapons_inventory"][key] = {}
    return bot_data["weapons_inventory"][key]

def get_user_resources(chat_id, user_id):
    key = get_user_key(chat_id, user_id)
    if key not in bot_data["resource_mines"]:
        bot_data["resource_mines"][key] = {"wood": 0, "coal": 0, "iron": 0}
    return bot_data["resource_mines"][key]

def get_user_diamond_mines(chat_id, user_id):
    key = get_user_key(chat_id, user_id)
    if key not in bot_data["diamond_mines"]:
        bot_data["diamond_mines"][key] = DIAMOND_MINE_CONFIG["starting_mines"]
        # Set initial collection time
        update_last_collection_time(chat_id, user_id, "diamond")
        save_data()
    return bot_data["diamond_mines"][key]

def add_user_diamond_mine(chat_id, user_id):
    key = get_user_key(chat_id, user_id)
    # Ensure mines are initialized
    current = get_user_diamond_mines(chat_id, user_id)
    bot_data["diamond_mines"][key] = current + 1
    save_data()

def add_user_resource_mine(chat_id, user_id, resource_type):
    key = get_user_key(chat_id, user_id)
    resource_key = f"{key}:{resource_type}"
    if resource_key not in bot_data["resource_mines"]:
        bot_data["resource_mines"][resource_key] = 0
    bot_data["resource_mines"][resource_key] += 1
    save_data()

def get_user_resource_mine_count(chat_id, user_id, resource_type):
    key = get_user_key(chat_id, user_id)
    resource_key = f"{key}:{resource_type}"
    return bot_data["resource_mines"].get(resource_key, 0)

def get_last_collection_time(chat_id, user_id, collection_type):
    key = get_user_key(chat_id, user_id)
    collection_key = f"{key}:{collection_type}"
    collection_dict = bot_data.get(f"last_{collection_type}_collection", {})
    return collection_dict.get(collection_key)

def update_last_collection_time(chat_id, user_id, collection_type):
    key = get_user_key(chat_id, user_id)
    collection_key = f"{key}:{collection_type}"
    if f"last_{collection_type}_collection" not in bot_data:
        bot_data[f"last_{collection_type}_collection"] = {}
    bot_data[f"last_{collection_type}_collection"][collection_key] = datetime.now().isoformat()
    save_data()

def calculate_military_power(inventory):
    total_power = 0
    for weapon_id, quantity in inventory.items():
        if weapon_id in WEAPONS_SHOP:
            total_power += WEAPONS_SHOP[weapon_id]["power"] * quantity
    return total_power

def get_leaderboard(chat_id):
    leaderboard = []
    # Get all users who have interacted with the bot in this chat
    user_keys = set()
    
    # Add users from points
    for key in bot_data["points"]:
        if key.startswith(f"{chat_id}:"):
            user_keys.add(key)
    
    # Add users from weapons inventory
    for key in bot_data["weapons_inventory"]:
        if key.startswith(f"{chat_id}:"):
            user_keys.add(key)
    
    # Add users from diamond mines
    for key in bot_data["diamond_mines"]:
        if key.startswith(f"{chat_id}:"):
            user_keys.add(key)
    
    # Add users from resource mines
    for key in bot_data["resource_mines"]:
        if key.startswith(f"{chat_id}:"):
            user_keys.add(key)
    
    # Create leaderboard entries
    for key in user_keys:
        parts = key.split(":")
        user_id = parts[1]
        power = calculate_military_power(bot_data["weapons_inventory"].get(key, {}))
        points = get_user_points(chat_id, user_id)
        leaderboard.append({
            "user_id": user_id,
            "power": power,
            "points": points
        })
    
    leaderboard.sort(key=itemgetter("power"), reverse=True)
    return leaderboard

def calculate_diamonds_available(chat_id, user_id):
    last_collected = get_last_collection_time(chat_id, user_id, "diamond")
    mines = get_user_diamond_mines(chat_id, user_id)
    
    # Fix: Initialize last collection time if missing
    if not last_collected:
        update_last_collection_time(chat_id, user_id, "diamond")
        return 0
    
    last_time = datetime.fromisoformat(last_collected)
    now = datetime.now()
    time_diff = now - last_time
    minutes_passed = time_diff.total_seconds() / 60
    
    production_cycles = int(minutes_passed // DIAMOND_MINE_CONFIG["production_rate"])
    return production_cycles * mines

def calculate_resources_available(chat_id, user_id, resource_type):
    last_collected = get_last_collection_time(chat_id, user_id, resource_type)
    mines = get_user_resource_mine_count(chat_id, user_id, resource_type)
    
    if mines == 0:
        return 0
        
    # Fix: Initialize last collection time if missing
    if not last_collected:
        update_last_collection_time(chat_id, user_id, resource_type)
        return 0
    
    last_time = datetime.fromisoformat(last_collected)
    now = datetime.now()
    time_diff = now - last_time
    minutes_passed = time_diff.total_seconds() / 60
    
    production_cycles = int(minutes_passed // RESOURCE_MINE_CONFIG[resource_type]["production_rate"])
    return production_cycles * mines * RESOURCE_MINE_CONFIG[resource_type]["output"]

def get_battle_cooldown(chat_id, user_id):
    key = get_user_key(chat_id, user_id)
    last_battle = bot_data["battle_history"].get(key, {}).get("last_battle")
    if not last_battle:
        return 0
    elapsed = datetime.now().timestamp() - last_battle
    return max(0, BATTLE_CONFIG["cooldown"] - elapsed)

def calculate_battle_outcome(attacker_power, defender_power):
    """Determines winner with randomness and power ratio"""
    power_ratio = attacker_power / max(defender_power, 1)
    win_chance = min(0.9, 0.5 + (power_ratio - 1) * 0.2)  # Caps at 90% chance
    return random.random() < win_chance

def calculate_weapon_losses(inventory, is_winner):
    losses = {}
    for weapon_id, quantity in inventory.items():
        if weapon_id not in WEAPONS_SHOP or quantity <= 0:
            continue
            
        base_rate = WEAPONS_SHOP[weapon_id]["loss_rate"]
        modifier = 0.7 if is_winner else 1.3  # Winner loses fewer units
        loss_count = max(1, int(quantity * base_rate * modifier * random.uniform(0.8, 1.2)))
        losses[weapon_id] = min(quantity, loss_count)
    return losses

def format_weapon_losses(losses):
    return ", ".join([f"{count} {WEAPONS_SHOP[wid]['name']}" for wid, count in losses.items()])

# Initialize bot
client = Bot(token="868869945:V2RKdBsKvh2Ew2CAPn6AvCkNMKDs43vyAoqPRZFU")

# Menu Keyboard Layout
def main_menu_keyboard():
    keyboard = MenuKeyboardMarkup()
    keyboard.add(MenuKeyboardButton("ğŸ›’ ÙØ±ÙˆØ´Ú¯Ø§Ù‡"))
    keyboard.add(MenuKeyboardButton("ğŸ’ Ù…ÙˆØ¬ÙˆØ¯ÛŒ"))
    keyboard.add(MenuKeyboardButton("âš”ï¸ Ø§Ø±ØªØ´"))
    keyboard.add(MenuKeyboardButton("ğŸ’° Ø§Ù…ØªÛŒØ§Ø²Ø§Øª"))
    keyboard.add(MenuKeyboardButton("ğŸ“¦ Ù…Ù†Ø§Ø¨Ø¹"))
    keyboard.add(MenuKeyboardButton("ğŸ† Ø±ØªØ¨Ù‡ Ø¨Ù†Ø¯ÛŒ"))
    keyboard.add(MenuKeyboardButton("â› Ù…Ø¹Ø§Ø¯Ù†"))
    keyboard.add(MenuKeyboardButton("ğŸ’ Ø¬Ù…Ø¹ Ø¢ÙˆØ±ÛŒ"))
    keyboard.add(MenuKeyboardButton("âš”ï¸ Ø­Ù…Ù„Ù‡"))
    return keyboard

def shop_keyboard():
    keyboard = MenuKeyboardMarkup()
    keyboard.add(MenuKeyboardButton("ğŸª– Ù¾ÛŒØ§Ø¯Ù‡ Ù†Ø¸Ø§Ù…"))
    keyboard.add(MenuKeyboardButton("âš”ï¸ ÙˆØ³Ø§ÛŒÙ„ Ù†Ù‚Ù„ÛŒÙ‡"))
    keyboard.add(MenuKeyboardButton("âœˆï¸ Ù‡ÙˆØ§Ù¾ÛŒÙ…Ø§Ù‡Ø§"))
    keyboard.add(MenuKeyboardButton("ğŸš¢ Ù†ÛŒØ±ÙˆÛŒ Ø¯Ø±ÛŒØ§ÛŒÛŒ"))
    keyboard.add(MenuKeyboardButton("ğŸ’£ ÙˆÛŒÚ˜Ù‡"))
    keyboard.add(MenuKeyboardButton("ğŸ“¦ Ø®Ø±ÛŒØ¯ Ù…Ù†Ø§Ø¨Ø¹"))
    keyboard.add(MenuKeyboardButton("ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª"))
    return keyboard

def mine_menu_keyboard():
    keyboard = MenuKeyboardMarkup()
    keyboard.add(MenuKeyboardButton("ğŸ’ Ù…Ø¹Ø§Ø¯Ù† Ø§Ù„Ù…Ø§Ø³"))
    keyboard.add(MenuKeyboardButton("ğŸªµ Ù…Ø¹Ø§Ø¯Ù† Ù…Ù†Ø§Ø¨Ø¹"))
    keyboard.add(MenuKeyboardButton("ğŸ›’ Ø®Ø±ÛŒØ¯ Ù…Ø¹Ø¯Ù† Ø§Ù„Ù…Ø§Ø³"))
    keyboard.add(MenuKeyboardButton("ğŸ›’ Ø®Ø±ÛŒØ¯ Ù…Ø¹Ø¯Ù† Ù…Ù†Ø¨Ø¹"))
    keyboard.add(MenuKeyboardButton("ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª"))
    return keyboard

def resource_mine_types_keyboard():
    keyboard = MenuKeyboardMarkup()
    keyboard.add(MenuKeyboardButton("ğŸªµ Ø®Ø±ÛŒØ¯ Ù…Ø¹Ø¯Ù† Ú†ÙˆØ¨"))
    keyboard.add(MenuKeyboardButton("ğŸª¨ Ø®Ø±ÛŒØ¯ Ù…Ø¹Ø¯Ù† Ø²ØºØ§Ù„ Ø³Ù†Ú¯"))
    keyboard.add(MenuKeyboardButton("â›“ï¸ Ø®Ø±ÛŒØ¯ Ù…Ø¹Ø¯Ù† Ø¢Ù‡Ù†"))
    keyboard.add(MenuKeyboardButton("ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª"))
    return keyboard

def resource_types_keyboard():
    keyboard = MenuKeyboardMarkup()
    keyboard.add(MenuKeyboardButton("ğŸªµ Ø®Ø±ÛŒØ¯ Ú†ÙˆØ¨"))
    keyboard.add(MenuKeyboardButton("ğŸª¨ Ø®Ø±ÛŒØ¯ Ø²ØºØ§Ù„ Ø³Ù†Ú¯"))
    keyboard.add(MenuKeyboardButton("â›“ï¸ Ø®Ø±ÛŒØ¯ Ø¢Ù‡Ù†"))
    keyboard.add(MenuKeyboardButton("ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª"))
    return keyboard

def back_only_keyboard():
    keyboard = MenuKeyboardMarkup()
    keyboard.add(MenuKeyboardButton("ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª"))
    return keyboard

def get_attack_keyboard(chat_id):
    """Create inline keyboard for attack targets"""
    leaderboard = get_leaderboard(chat_id)[:10]  # Top 10 players
    keyboard = InlineKeyboard()
    
    for player in leaderboard:
        user_name = get_user_name(player["user_id"])
        keyboard.add(InlineKeyboardButton(
            f"âš”ï¸ Ø­Ù…Ù„Ù‡ Ø¨Ù‡ {user_name}",
            callback_data=f"attack_{player['user_id']}"
        ))
    
    return keyboard

HELP_TEXT = f"""
ğŸ® **Ø±Ø¨Ø§Øª ÙØ±Ù…Ø§Ù†Ø¯Ù‡ Ø¬Ù†Ú¯** ğŸ®
Ø§Ù…Ù¾Ø±Ø§ØªÙˆØ±ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø³Ø§Ø²ÛŒØ¯ØŒ Ù…Ù†Ø§Ø¨Ø¹ Ø¬Ù…Ø¹ Ø¢ÙˆØ±ÛŒ Ú©Ù†ÛŒØ¯ØŒ Ø³Ù„Ø§Ø­ ØªÙˆÙ„ÛŒØ¯ Ú©Ù†ÛŒØ¯ Ùˆ Ø¯Ø´Ù…Ù†Ø§Ù† Ø±Ø§ ÙØªØ­ Ú©Ù†ÛŒØ¯!

**Ø¯Ø³ØªÙˆØ±Ø§Øª Ø§ØµÙ„ÛŒ:**
- Ø§Ø² Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø³Ø±ÛŒØ¹ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯
- `/attack` - Ø­Ù…Ù„Ù‡ Ø¨Ù‡ Ø¨Ø§Ø²ÛŒÚ©Ù† Ø¯ÛŒÚ¯Ø±
- `/help` - Ù†Ù…Ø§ÛŒØ´ Ø±Ø§Ù‡Ù†Ù…Ø§

**ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒ:**
- ğŸ’ Ù…Ø¹Ø§Ø¯Ù† Ø§Ù„Ù…Ø§Ø³ Ø§Ù…ØªÛŒØ§Ø² ØªÙˆÙ„ÛŒØ¯ Ù…ÛŒâ€ŒÚ©Ù†Ù†Ø¯
- â› Ù…Ø¹Ø§Ø¯Ù† Ù…Ù†Ø§Ø¨Ø¹ (Ú†ÙˆØ¨ØŒ Ø²ØºØ§Ù„ Ø³Ù†Ú¯ØŒ Ø¢Ù‡Ù†) Ø¨Ø±Ø§ÛŒ ØªÙˆÙ„ÛŒØ¯
- ğŸ­ Ø³ÛŒØ³ØªÙ… Ú©Ø§Ø±Ø®Ø§Ù†Ù‡ Ø¨Ø±Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ ÙˆØ§Ø­Ø¯Ù‡Ø§ÛŒ Ù†Ø¸Ø§Ù…ÛŒ
- âš”ï¸ Ø³ÛŒØ³ØªÙ… Ù†Ø¨Ø±Ø¯ Ø¨Ø§ Ù¾Ø§Ø¯Ø§Ø´ Ùˆ ØªÙ„ÙØ§Øª
- ğŸ† Ø¬Ø¯ÙˆÙ„ Ø±ØªØ¨Ù‡ Ø¨Ù†Ø¯ÛŒ Ø¨Ø±Ø§ÛŒ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ Ø¨Ù‡ØªØ±ÛŒÙ† Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†
- ğŸ›’ Ø®Ø±ÛŒØ¯ Ù…Ù†Ø§Ø¨Ø¹ Ù…Ø³ØªÙ‚ÛŒÙ… Ø§Ø² Ø¨Ø§Ø²Ø§Ø±

Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ø§Ø² Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯!
"""

# Event handlers
@client.event
async def on_ready():
    print(f"{client.user.username} Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª!")

@client.event
async def on_message(message: Message):
    if message.content is None:
        return
    
    content = message.content.strip()
    content_lower = content.lower()
    chat_id = str(message.chat.id)
    user_id = str(message.author.user_id)
    
    # Update user info
    update_user_info(message.author)
    
    # Command handlers
    if content_lower in ["/start", "/help"]:
        await message.reply(HELP_TEXT, components=main_menu_keyboard())
    elif content_lower == "/attack":
        await show_attack_targets(message)
    elif content_lower == "/shop":
        await show_weapons_shop(message)
    elif content_lower == "/inventory":
        await show_inventory(message)
    elif content_lower == "/military":
        await show_military_power(message)
    elif content_lower == "/points":
        await show_points(message)
    elif content_lower == "/resources":
        await show_resources(message)
    elif content_lower == "/leaderboard":
        await show_leaderboard(message)
    elif content_lower == "/collect":
        await collect_all(message)
    elif content_lower == "/mines":
        await show_mines_menu(message)
    elif content_lower.startswith("/buy_"):
        if content_lower.startswith("/buydiamondmine"):
            await buy_diamond_mine(message)
        elif content_lower.startswith("/buyresourcemine"):
            await buy_resource_mine(message)
        elif content_lower.startswith("/buyresource"):
            await buy_resource(message)
        else:
            await buy_weapon(message)
    
    # Handle button presses
    elif content == "ğŸ›’ ÙØ±ÙˆØ´Ú¯Ø§Ù‡":
        await show_weapons_shop(message)
    elif content == "ğŸ’ Ù…ÙˆØ¬ÙˆØ¯ÛŒ":
        await show_inventory(message)
    elif content == "âš”ï¸ Ø§Ø±ØªØ´":
        await show_military_power(message)
    elif content == "ğŸ’° Ø§Ù…ØªÛŒØ§Ø²Ø§Øª":
        await show_points(message)
    elif content == "ğŸ“¦ Ù…Ù†Ø§Ø¨Ø¹":
        await show_resources(message)
    elif content == "ğŸ† Ø±ØªØ¨Ù‡ Ø¨Ù†Ø¯ÛŒ":
        await show_leaderboard(message)
    elif content == "â› Ù…Ø¹Ø§Ø¯Ù†":
        await show_mines_menu(message)
    elif content == "ğŸ’ Ø¬Ù…Ø¹ Ø¢ÙˆØ±ÛŒ":
        await collect_all(message)
    elif content == "âš”ï¸ Ø­Ù…Ù„Ù‡":
        await show_attack_targets(message)
    elif content == "ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª":
        await message.reply(HELP_TEXT, components=main_menu_keyboard())
    elif content == "ğŸª– Ù¾ÛŒØ§Ø¯Ù‡ Ù†Ø¸Ø§Ù…":
        await show_weapon_category(message, "infantry")
    elif content == "âš”ï¸ ÙˆØ³Ø§ÛŒÙ„ Ù†Ù‚Ù„ÛŒÙ‡":
        await show_weapon_category(message, "vehicles")
    elif content == "âœˆï¸ Ù‡ÙˆØ§Ù¾ÛŒÙ…Ø§Ù‡Ø§":
        await show_weapon_category(message, "aircraft")
    elif content == "ğŸš¢ Ù†ÛŒØ±ÙˆÛŒ Ø¯Ø±ÛŒØ§ÛŒÛŒ":
        await show_weapon_category(message, "naval")
    elif content == "ğŸ’£ ÙˆÛŒÚ˜Ù‡":
        await show_weapon_category(message, "special")
    elif content == "ğŸ“¦ Ø®Ø±ÛŒØ¯ Ù…Ù†Ø§Ø¨Ø¹":
        await show_resource_shop(message)
    elif content == "ğŸ’ Ù…Ø¹Ø§Ø¯Ù† Ø§Ù„Ù…Ø§Ø³":
        await show_diamond_mines_status(message)
    elif content == "ğŸªµ Ù…Ø¹Ø§Ø¯Ù† Ù…Ù†Ø§Ø¨Ø¹":
        await show_resource_mines_status(message)
    elif content == "ğŸ›’ Ø®Ø±ÛŒØ¯ Ù…Ø¹Ø¯Ù† Ø§Ù„Ù…Ø§Ø³":
        await buy_diamond_mine(message)
    elif content == "ğŸ›’ Ø®Ø±ÛŒØ¯ Ù…Ø¹Ø¯Ù† Ù…Ù†Ø¨Ø¹":
        await show_resource_mine_types(message)
    elif content == "ğŸªµ Ø®Ø±ÛŒØ¯ Ù…Ø¹Ø¯Ù† Ú†ÙˆØ¨":
        await buy_resource_mine(message, "wood")
    elif content == "ğŸª¨ Ø®Ø±ÛŒØ¯ Ù…Ø¹Ø¯Ù† Ø²ØºØ§Ù„ Ø³Ù†Ú¯":
        await buy_resource_mine(message, "coal")
    elif content == "â›“ï¸ Ø®Ø±ÛŒØ¯ Ù…Ø¹Ø¯Ù† Ø¢Ù‡Ù†":
        await buy_resource_mine(message, "iron")
    elif content == "ğŸªµ Ø®Ø±ÛŒØ¯ Ú†ÙˆØ¨":
        await buy_resource(message, "wood")
    elif content == "ğŸª¨ Ø®Ø±ÛŒØ¯ Ø²ØºØ§Ù„ Ø³Ù†Ú¯":
        await buy_resource(message, "coal")
    elif content == "â›“ï¸ Ø®Ø±ÛŒØ¯ Ø¢Ù‡Ù†":
        await buy_resource(message, "iron")

@client.event
async def on_callback_query(callback_query):
    data = callback_query.data
    chat_id = str(callback_query.message.chat.id)
    user_id = str(callback_query.from_user.user_id)
    
    if data.startswith("attack_"):
        defender_id = data.split("_")[1]
        await attack_player(callback_query.message, defender_id)
    
    await callback_query.answer()

# Text-based command handlers
async def show_attack_targets(message: Message):
    chat_id = str(message.chat.id)
    user_id = str(message.author.user_id)
    
    # Check cooldown
    cooldown = get_battle_cooldown(chat_id, user_id)
    if cooldown > 0:
        minutes = int(cooldown // 60)
        seconds = int(cooldown % 60)
        await message.reply(f"â³ Ø¨Ø§ÛŒØ¯ {minutes} Ø¯Ù‚ÛŒÙ‚Ù‡ Ùˆ {seconds} Ø«Ø§Ù†ÛŒÙ‡ ØµØ¨Ø± Ú©Ù†ÛŒØ¯ Ù‚Ø¨Ù„ Ø§Ø² Ø­Ù…Ù„Ù‡ Ù…Ø¬Ø¯Ø¯!")
        return
    
    keyboard = get_attack_keyboard(chat_id)
    await message.reply(
        "âš”ï¸ **Ù‡Ø¯Ù Ø­Ù…Ù„Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯**\n"
        "Ù„ÛŒØ³Øª Û±Û° Ø¨Ø§Ø²ÛŒÚ©Ù† Ø¨Ø±ØªØ±:",
        components=keyboard
    )

async def show_weapons_shop(message: Message):
    await message.reply(
        "ğŸª **ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ø³Ù„Ø§Ø­**\nÛŒÚ© Ø¯Ø³ØªÙ‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:",
        components=shop_keyboard()
    )

async def show_weapon_category(message: Message, category: str):
    categories = {
        "infantry": ["soldier"],
        "vehicles": ["tank", "apache"],
        "aircraft": ["fighter_jet", "su47", "drone"],
        "naval": ["battleship", "submarine"],
        "special": ["nuke"]
    }
    
    response = f"ğŸ”« **Ø³Ù„Ø§Ø­â€ŒÙ‡Ø§ÛŒ {category}**\n\n"
    for weapon_id in categories.get(category, []):
        weapon = WEAPONS_SHOP[weapon_id]
        resource_cost = ""
        for r_type, amount in weapon.get("resources", {}).items():
            emoji = RESOURCE_TYPES[r_type]["emoji"]
            resource_cost += f"{emoji} {amount} "
        
        response += (
            f"{weapon['emoji']} **{weapon['name']}**\n"
            f"âš”ï¸ Ù‚Ø¯Ø±Øª: {weapon['power']} | ğŸ’° Ù‚ÛŒÙ…Øª: {weapon['price']} Ø§Ù…ØªÛŒØ§Ø²\n"
            f"ğŸ“¦ Ù…Ù†Ø§Ø¨Ø¹: {resource_cost.strip()}\n"
            f"ğŸ“ {weapon['description']}\n"
            f"Ø¨Ø±Ø§ÛŒ Ø®Ø±ÛŒØ¯: /buy_{weapon_id}\n\n"
        )
    
    await message.reply(response, components=back_only_keyboard())

async def show_resource_shop(message: Message):
    response = "ğŸ›’ **Ø¨Ø§Ø²Ø§Ø± Ù…Ù†Ø§Ø¨Ø¹**\nØ®Ø±ÛŒØ¯ Ù…Ø³ØªÙ‚ÛŒÙ… Ù…Ù†Ø§Ø¨Ø¹:\n\n"
    for r_type, info in RESOURCE_TYPES.items():
        response += (
            f"{info['emoji']} **{info['name']}**\n"
            f"ğŸ’° Ù‚ÛŒÙ…Øª: {info['price']} Ø§Ù…ØªÛŒØ§Ø² Ø¨Ù‡ Ø§Ø²Ø§ÛŒ Ù‡Ø± ÙˆØ§Ø­Ø¯\n"
            f"Ø¨Ø±Ø§ÛŒ Ø®Ø±ÛŒØ¯ Ø§Ø² Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯\n\n"
        )
    
    await message.reply(
        response,
        components=resource_types_keyboard()
    )

async def buy_resource(message: Message, resource_type=None):
    chat_id = str(message.chat.id)
    user_id = str(message.author.user_id)
    
    # If resource type not provided, try to get from command
    if resource_type is None:
        parts = message.content.strip().split()
        if len(parts) < 2:
            await message.reply("âŒ Ø±ÙˆØ´ Ø§Ø³ØªÙØ§Ø¯Ù‡: /buyresource <wood|coal|iron> <Ù…Ù‚Ø¯Ø§Ø±>")
            return
        resource_type = parts[1].lower()
    
    if resource_type not in RESOURCE_TYPES:
        await message.reply("âŒ Ù†ÙˆØ¹ Ù…Ù†Ø¨Ø¹ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª. Ø§Ø² Ø¨ÛŒÙ† Ù…ÙˆØ§Ø±Ø¯ Ø²ÛŒØ± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯: wood, coal, iron")
        return
    
    # Get amount (default to 1 if not specified)
    amount = 1
    if len(message.content.split()) > 2:
        try:
            amount = int(message.content.split()[2])
            if amount < 1:
                amount = 1
            elif amount > 1000:
                amount = 1000
        except:
            amount = 1
    
    resource_info = RESOURCE_TYPES[resource_type]
    total_cost = resource_info["price"] * amount
    user_points = get_user_points(chat_id, user_id)
    
    if user_points < total_cost:
        await message.reply(
            f"âŒ Ø§Ù…ØªÛŒØ§Ø² Ú©Ø§ÙÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯! Ø´Ù…Ø§ Ø¨Ù‡ {total_cost} Ø§Ù…ØªÛŒØ§Ø² Ù†ÛŒØ§Ø² Ø¯Ø§Ø±ÛŒØ¯ "
            f"ÙˆÙ„ÛŒ ÙÙ‚Ø· {user_points} Ø§Ù…ØªÛŒØ§Ø² Ø¯Ø§Ø±ÛŒØ¯."
        )
        return
    
    # Deduct points and add resources
    award_points(chat_id, user_id, -total_cost)
    resources = get_user_resources(chat_id, user_id)
    resources[resource_type] = resources.get(resource_type, 0) + amount
    save_data()
    
    await message.reply(
        f"âœ… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª {amount} {resource_info['emoji']} {resource_info['name']} Ø®Ø±ÛŒØ¯Ø§Ø±ÛŒ Ø´Ø¯! "
        f"Ø¨Ù‡ Ù…Ø¨Ù„Øº {total_cost} Ø§Ù…ØªÛŒØ§Ø²!\n"
        f"Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¬Ø¯ÛŒØ¯ Ø´Ù…Ø§: {get_user_points(chat_id, user_id)} Ø§Ù…ØªÛŒØ§Ø²\n"
        f"Ù…Ø¬Ù…ÙˆØ¹ {resource_info['name']}: {resources[resource_type]}"
    )

async def show_inventory(message: Message):
    chat_id = str(message.chat.id)
    user_id = str(message.author.user_id)
    inventory = get_user_inventory(chat_id, user_id)
    
    if not inventory:
        await message.reply(
            "ğŸ’ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø´Ù…Ø§ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.\nØ¨Ø±Ø§ÛŒ Ø®Ø±ÛŒØ¯ Ø³Ù„Ø§Ø­ Ø¨Ù‡ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ù…Ø±Ø§Ø¬Ø¹Ù‡ Ú©Ù†ÛŒØ¯!",
            components=MenuKeyboardMarkup().add(MenuKeyboardButton("ğŸ›’ ÙØ±ÙˆØ´Ú¯Ø§Ù‡")))
        return
    
    inventory_text = "ğŸ’ **Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø³Ù„Ø§Ø­â€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§** ğŸ’\n\n"
    total_power = 0
    
    for weapon_id, quantity in inventory.items():
        if weapon_id in WEAPONS_SHOP:
            weapon = WEAPONS_SHOP[weapon_id]
            power_contribution = weapon['power'] * quantity
            inventory_text += f"{weapon['emoji']} {weapon['name']} x{quantity} (âš”ï¸ {power_contribution})\n"
            total_power += power_contribution
    
    inventory_text += f"\n**Ù…Ø¬Ù…ÙˆØ¹ Ù‚Ø¯Ø±Øª Ù†Ø¸Ø§Ù…ÛŒ**: âš”ï¸ {total_power}"
    
    keyboard = MenuKeyboardMarkup()
    keyboard.add(MenuKeyboardButton("ğŸ›’ ÙØ±ÙˆØ´Ú¯Ø§Ù‡"))
    keyboard.add(MenuKeyboardButton("âš”ï¸ Ø­Ù…Ù„Ù‡"))
    keyboard.add(MenuKeyboardButton("ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª"))
    
    await message.reply(inventory_text, components=keyboard)

async def show_military_power(message: Message):
    chat_id = str(message.chat.id)
    user_id = str(message.author.user_id)
    inventory = get_user_inventory(chat_id, user_id)
    total_power = calculate_military_power(inventory)
    
    keyboard = MenuKeyboardMarkup()
    keyboard.add(MenuKeyboardButton("ğŸ’ Ù…ÙˆØ¬ÙˆØ¯ÛŒ"))
    keyboard.add(MenuKeyboardButton("ğŸ›’ ÙØ±ÙˆØ´Ú¯Ø§Ù‡"))
    keyboard.add(MenuKeyboardButton("ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª"))
    
    await message.reply(
        f"âš”ï¸ **Ù‚Ø¯Ø±Øª Ù†Ø¸Ø§Ù…ÛŒ Ø´Ù…Ø§** âš”ï¸\n"
        f"**Ù…Ø¬Ù…ÙˆØ¹**: {total_power}\n\n"
        f"Ø¨Ø±Ø§ÛŒ Ø¬Ø²Ø¦ÛŒØ§Øª Ø¨ÛŒØ´ØªØ± Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø¨ÛŒÙ†ÛŒØ¯",
        components=keyboard
    )

async def show_points(message: Message):
    chat_id = str(message.chat.id)
    user_id = str(message.author.user_id)
    points = get_user_points(chat_id, user_id)
    
    keyboard = MenuKeyboardMarkup()
    keyboard.add(MenuKeyboardButton("â› Ø¬Ù…Ø¹ Ø¢ÙˆØ±ÛŒ"))
    keyboard.add(MenuKeyboardButton("ğŸ›’ ÙØ±ÙˆØ´Ú¯Ø§Ù‡"))
    keyboard.add(MenuKeyboardButton("ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª"))
    
    await message.reply(
        f"ğŸ’° **Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø§Ù…ØªÛŒØ§Ø²Ø§Øª Ø´Ù…Ø§** ğŸ’°\n"
        f"**Ù…Ø¬Ù…ÙˆØ¹**: {points} Ø§Ù…ØªÛŒØ§Ø²\n\n"
        f"Ø¨Ø±Ø§ÛŒ Ú©Ø³Ø¨ Ø§Ù…ØªÛŒØ§Ø² Ø¨ÛŒØ´ØªØ± Ø§Ø² Ù…Ø¹Ø§Ø¯Ù† Ø¬Ù…Ø¹ Ø¢ÙˆØ±ÛŒ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø¯Ø± Ù†Ø¨Ø±Ø¯Ù‡Ø§ Ù¾ÛŒØ±ÙˆØ² Ø´ÙˆÛŒØ¯!",
        components=keyboard
    )

async def show_resources(message: Message):
    chat_id = str(message.chat.id)
    user_id = str(message.author.user_id)
    resources = get_user_resources(chat_id, user_id)
    
    resource_text = "ğŸ“¦ **Ù…Ù†Ø§Ø¨Ø¹ Ø´Ù…Ø§** ğŸ“¦\n\n"
    for r_type, info in RESOURCE_TYPES.items():
        emoji = info["emoji"]
        name = info["name"]
        amount = resources.get(r_type, 0)
        resource_text += f"{emoji} **{name}**: {amount}\n"
    
    keyboard = MenuKeyboardMarkup()
    keyboard.add(MenuKeyboardButton("â› Ø¬Ù…Ø¹ Ø¢ÙˆØ±ÛŒ"))
    keyboard.add(MenuKeyboardButton("ğŸ›’ ÙØ±ÙˆØ´Ú¯Ø§Ù‡"))
    keyboard.add(MenuKeyboardButton("ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª"))
    
    await message.reply(resource_text, components=keyboard)

async def show_leaderboard(message: Message):
    chat_id = str(message.chat.id)
    leaderboard = get_leaderboard(chat_id)
    
    if not leaderboard:
        await message.reply(
            "ğŸ† **Ø¬Ø¯ÙˆÙ„ Ø±ØªØ¨Ù‡ Ø¨Ù†Ø¯ÛŒ** ğŸ†\n\n"
            "Ù‡Ù†ÙˆØ² Ø¨Ø§Ø²ÛŒÚ©Ù†ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯! Ø¨Ø±Ø§ÛŒ Ø¸Ø§Ù‡Ø± Ø´Ø¯Ù† Ø¯Ø± Ø¬Ø¯ÙˆÙ„ Ø±ØªØ¨Ù‡ Ø¨Ù†Ø¯ÛŒ Ø³Ù„Ø§Ø­ Ø¨Ø®Ø±ÛŒØ¯.",
            components=MenuKeyboardMarkup().add(MenuKeyboardButton("ğŸ›’ ÙØ±ÙˆØ´Ú¯Ø§Ù‡")))
        return
    
    leaderboard_text = "ğŸ† **Ø¬Ø¯ÙˆÙ„ Ø±ØªØ¨Ù‡ Ø¨Ù†Ø¯ÛŒ Ù‚Ø¯Ø±Øª Ù†Ø¸Ø§Ù…ÛŒ** ğŸ†\n\n"
    
    for index, player in enumerate(leaderboard[:10], 1):  # Show top 10
        username = get_user_name(player["user_id"])
            
        leaderboard_text += (
            f"{index}. **{username}**\n"
            f"âš”ï¸ Ù‚Ø¯Ø±Øª: {player['power']} | ğŸ’° Ø§Ù…ØªÛŒØ§Ø²: {player['points']}\n\n"
        )
    
    keyboard = MenuKeyboardMarkup()
    keyboard.add(MenuKeyboardButton("âš”ï¸ Ø­Ù…Ù„Ù‡"))
    keyboard.add(MenuKeyboardButton("ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª"))
    
    await message.reply(leaderboard_text, components=keyboard)

async def collect_all(message: Message):
    chat_id = str(message.chat.id)
    user_id = str(message.author.user_id)
    collected_resources = {}
    response = "â› **Ú¯Ø²Ø§Ø±Ø´ Ø¬Ù…Ø¹ Ø¢ÙˆØ±ÛŒ** â›\n\n"
    
    # Collect diamonds
    diamonds = calculate_diamonds_available(chat_id, user_id)
    if diamonds > 0:
        earnings = diamonds * DIAMOND_MINE_CONFIG["diamond_value"]
        award_points(chat_id, user_id, earnings)
        update_last_collection_time(chat_id, user_id, "diamond")
        response += f"ğŸ’ **Ø§Ù„Ù…Ø§Ø³ Ø¬Ù…Ø¹ Ø¢ÙˆØ±ÛŒ Ø´Ø¯Ù‡**: {diamonds} (ğŸ’° +{earnings} Ø§Ù…ØªÛŒØ§Ø²)\n"
    
    # Collect resources
    for resource_type in RESOURCE_TYPES:
        amount = calculate_resources_available(chat_id, user_id, resource_type)
        if amount > 0:
            resources = get_user_resources(chat_id, user_id)
            resources[resource_type] = resources.get(resource_type, 0) + amount
            update_last_collection_time(chat_id, user_id, resource_type)
            collected_resources[resource_type] = amount
    
    if collected_resources:
        response += "\nğŸ“¦ **Ù…Ù†Ø§Ø¨Ø¹ Ø¬Ù…Ø¹ Ø¢ÙˆØ±ÛŒ Ø´Ø¯Ù‡**:\n"
        for r_type, amount in collected_resources.items():
            emoji = RESOURCE_TYPES[r_type]["emoji"]
            name = RESOURCE_TYPES[r_type]["name"]
            response += f"{emoji} **{name}**: +{amount}\n"
    
    if diamonds == 0 and not collected_resources:
        response += "â³ Ù‡Ù†ÙˆØ² Ú†ÛŒØ²ÛŒ Ø¨Ø±Ø§ÛŒ Ø¬Ù…Ø¹ Ø¢ÙˆØ±ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯. Ù…Ø¹Ø§Ø¯Ù† Ø´Ù…Ø§ Ù‡Ù†ÙˆØ² Ø¯Ø± Ø­Ø§Ù„ Ú©Ø§Ø± Ù‡Ø³ØªÙ†Ø¯!"
    else:
        response += f"\nğŸ’° **Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¬Ø¯ÛŒØ¯**: {get_user_points(chat_id, user_id)} Ø§Ù…ØªÛŒØ§Ø²"
    
    keyboard = MenuKeyboardMarkup()
    keyboard.add(MenuKeyboardButton("â› ÙˆØ¶Ø¹ÛŒØª Ù…Ø¹Ø§Ø¯Ù†"))
    keyboard.add(MenuKeyboardButton("ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª"))
    
    await message.reply(response, components=keyboard)

async def show_mines_menu(message: Message):
    await message.reply(
        "â› **Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø¹Ø§Ø¯Ù†** â›\n\n"
        "Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø¹Ø§Ø¯Ù† Ø§Ù„Ù…Ø§Ø³ Ùˆ Ù…Ù†Ø§Ø¨Ø¹ Ø®ÙˆØ¯",
        components=mine_menu_keyboard()
    )

async def show_resource_mine_types(message: Message):
    response = "ğŸ›’ **Ø®Ø±ÛŒØ¯ Ù…Ø¹Ø¯Ù† Ù…Ù†Ø¨Ø¹**\nÙ†ÙˆØ¹ Ù…Ø¹Ø¯Ù† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:\n\n"
    for r_type, config in RESOURCE_MINE_CONFIG.items():
        response += (
            f"{config['emoji']} **{config['name']}**\n"
            f"ğŸ’° Ù‚ÛŒÙ…Øª: {config['price']} Ø§Ù…ØªÛŒØ§Ø²\n"
            f"ğŸ“¦ ØªÙˆÙ„ÛŒØ¯: {config['output']} {RESOURCE_TYPES[r_type]['name']} "
            f"Ù‡Ø± {config['production_rate']} Ø¯Ù‚ÛŒÙ‚Ù‡\n\n"
        )
    
    await message.reply(
        response,
        components=resource_mine_types_keyboard()
    )

async def show_diamond_mines_status(message: Message):
    chat_id = str(message.chat.id)
    user_id = str(message.author.user_id)
    mines = get_user_diamond_mines(chat_id, user_id)
    last_collected = get_last_collection_time(chat_id, user_id, "diamond")
    
    status_text = "ğŸ’ **ÙˆØ¶Ø¹ÛŒØª Ù…Ø¹Ø§Ø¯Ù† Ø§Ù„Ù…Ø§Ø³** ğŸ’\n\n"
    status_text += f"**Ù…Ø¬Ù…ÙˆØ¹ Ù…Ø¹Ø§Ø¯Ù†**: {mines}\n"
    
    if last_collected:
        last_time = datetime.fromisoformat(last_collected)
        next_collection = last_time + timedelta(minutes=DIAMOND_MINE_CONFIG["production_rate"])
        now = datetime.now()
        
        if now >= next_collection:
            diamonds_available = calculate_diamonds_available(chat_id, user_id)
            status_text += f"ğŸ’ **Ø§Ù„Ù…Ø§Ø³ Ø¢Ù…Ø§Ø¯Ù‡**: {diamonds_available} (ğŸ’° {diamonds_available * DIAMOND_MINE_CONFIG['diamond_value']} Ø§Ù…ØªÛŒØ§Ø²)\n"
        else:
            wait_time = next_collection - now
            wait_minutes = max(0, int(wait_time.total_seconds() / 60))
            status_text += f"â³ **Ø¬Ù…Ø¹ Ø¢ÙˆØ±ÛŒ Ø¨Ø¹Ø¯ÛŒ Ø¯Ø±**: {wait_minutes} Ø¯Ù‚ÛŒÙ‚Ù‡\n"
    else:
        status_text += "â³ Ù…Ø¹Ø§Ø¯Ù† Ø´Ù…Ø§ ØªØ§Ø²Ù‡ Ø´Ø±ÙˆØ¹ Ø¨Ù‡ Ú©Ø§Ø± Ú©Ø±Ø¯Ù‡â€ŒØ§Ù†Ø¯!\n"
        status_text += f"**Ø§ÙˆÙ„ÛŒÙ† Ø¬Ù…Ø¹ Ø¢ÙˆØ±ÛŒ Ø¯Ø±**: {DIAMOND_MINE_CONFIG['production_rate']} Ø¯Ù‚ÛŒÙ‚Ù‡\n"
    
    keyboard = MenuKeyboardMarkup()
    keyboard.add(MenuKeyboardButton("ğŸ’ Ø¬Ù…Ø¹ Ø¢ÙˆØ±ÛŒ"))
    keyboard.add(MenuKeyboardButton("ğŸ›’ Ø®Ø±ÛŒØ¯ Ù…Ø¹Ø¯Ù† Ø§Ù„Ù…Ø§Ø³"))
    keyboard.add(MenuKeyboardButton("ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª"))
    
    await message.reply(status_text, components=keyboard)

async def show_resource_mines_status(message: Message):
    chat_id = str(message.chat.id)
    user_id = str(message.author.user_id)
    status_text = "â› **ÙˆØ¶Ø¹ÛŒØª Ù…Ø¹Ø§Ø¯Ù† Ù…Ù†Ø§Ø¨Ø¹** â›\n\n"
    
    for resource_type, config in RESOURCE_MINE_CONFIG.items():
        mine_count = get_user_resource_mine_count(chat_id, user_id, resource_type)
        last_collected = get_last_collection_time(chat_id, user_id, resource_type)
        resource_info = RESOURCE_TYPES[resource_type]
        
        status_text += f"{config['emoji']} **{config['name']}**: {mine_count}\n"
        
        if last_collected:
            last_time = datetime.fromisoformat(last_collected)
            next_collection = last_time + timedelta(minutes=config["production_rate"])
            now = datetime.now()
            
            if now >= next_collection:
                resources_available = calculate_resources_available(chat_id, user_id, resource_type)
                status_text += f"  {resource_info['emoji']} **{resource_info['name']} Ø¢Ù…Ø§Ø¯Ù‡**: {resources_available}\n"
            else:
                wait_time = next_collection - now
                wait_minutes = max(0, int(wait_time.total_seconds() / 60))
                status_text += f"  â³ **Ø¬Ù…Ø¹ Ø¢ÙˆØ±ÛŒ Ø¨Ø¹Ø¯ÛŒ Ø¯Ø±**: {wait_minutes} Ø¯Ù‚ÛŒÙ‚Ù‡\n"
        elif mine_count > 0:
            status_text += f"  â³ **Ø§ÙˆÙ„ÛŒÙ† Ø¬Ù…Ø¹ Ø¢ÙˆØ±ÛŒ Ø¯Ø±**: {config['production_rate']} Ø¯Ù‚ÛŒÙ‚Ù‡\n"
        
        status_text += "\n"
    
    keyboard = MenuKeyboardMarkup()
    keyboard.add(MenuKeyboardButton("ğŸ’ Ø¬Ù…Ø¹ Ø¢ÙˆØ±ÛŒ"))
    keyboard.add(MenuKeyboardButton("ğŸ›’ Ø®Ø±ÛŒØ¯ Ù…Ø¹Ø¯Ù† Ù…Ù†Ø¨Ø¹"))
    keyboard.add(MenuKeyboardButton("ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª"))
    
    await message.reply(status_text, components=keyboard)

# Resource and mine commands
async def buy_diamond_mine(message: Message):
    chat_id = str(message.chat.id)
    user_id = str(message.author.user_id)
    price = DIAMOND_MINE_CONFIG["price"]
    user_points = get_user_points(chat_id, user_id)
    
    if user_points < price:
        await message.reply(f"âŒ Ø§Ù…ØªÛŒØ§Ø² Ú©Ø§ÙÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯! Ø´Ù…Ø§ Ø¨Ù‡ {price} Ø§Ù…ØªÛŒØ§Ø² Ù†ÛŒØ§Ø² Ø¯Ø§Ø±ÛŒØ¯ ÙˆÙ„ÛŒ ÙÙ‚Ø· {user_points} Ø§Ù…ØªÛŒØ§Ø² Ø¯Ø§Ø±ÛŒØ¯.")
        return
    
    # Deduct points and add mine
    award_points(chat_id, user_id, -price)
    add_user_diamond_mine(chat_id, user_id)
    
    await message.reply(
        f"âœ… Ù…Ø¹Ø¯Ù† Ø§Ù„Ù…Ø§Ø³ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡ Ù…Ø¨Ù„Øº {price} Ø§Ù…ØªÛŒØ§Ø² Ø®Ø±ÛŒØ¯Ø§Ø±ÛŒ Ø´Ø¯!\n"
        f"Ø§Ú©Ù†ÙˆÙ† {get_user_diamond_mines(chat_id, user_id)} Ù…Ø¹Ø¯Ù† Ø§Ù„Ù…Ø§Ø³ Ø¯Ø§Ø±ÛŒØ¯.\n"
        f"Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¬Ø¯ÛŒØ¯ Ø´Ù…Ø§: {get_user_points(chat_id, user_id)} Ø§Ù…ØªÛŒØ§Ø²"
    )

async def buy_resource_mine(message: Message, resource_type=None):
    chat_id = str(message.chat.id)
    user_id = str(message.author.user_id)
    
    # If resource type not provided, try to get from command
    if resource_type is None:
        if hasattr(message, 'content') and message.content:
            parts = message.content.strip().split()
            if len(parts) < 2:
                await message.reply("âŒ Ø±ÙˆØ´ Ø§Ø³ØªÙØ§Ø¯Ù‡: /buyresourcemine <wood|coal|iron>")
                return
            resource_type = parts[1].lower()
        else:
            # Try to get from button context
            if message == "ğŸªµ Ø®Ø±ÛŒØ¯ Ù…Ø¹Ø¯Ù† Ú†ÙˆØ¨":
                resource_type = "wood"
            elif message == "ğŸª¨ Ø®Ø±ÛŒØ¯ Ù…Ø¹Ø¯Ù† Ø²ØºØ§Ù„ Ø³Ù†Ú¯":
                resource_type = "coal"
            elif message == "â›“ï¸ Ø®Ø±ÛŒØ¯ Ù…Ø¹Ø¯Ù† Ø¢Ù‡Ù†":
                resource_type = "iron"
            else:
                await message.reply("âŒ Ù„Ø·ÙØ§ Ù†ÙˆØ¹ Ù…Ù†Ø¨Ø¹ Ø±Ø§ Ù…Ø´Ø®Øµ Ú©Ù†ÛŒØ¯")
                return
    
    if resource_type not in RESOURCE_MINE_CONFIG:
        await message.reply(f"âŒ Ù†ÙˆØ¹ Ù…Ù†Ø¨Ø¹ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª. Ø§Ø² Ø¨ÛŒÙ† Ù…ÙˆØ§Ø±Ø¯ Ø²ÛŒØ± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯: wood, coal, iron")
        return
    
    config = RESOURCE_MINE_CONFIG[resource_type]
    user_points = get_user_points(chat_id, user_id)
    
    if user_points < config["price"]:
        await message.reply(f"âŒ Ø§Ù…ØªÛŒØ§Ø² Ú©Ø§ÙÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯! Ø´Ù…Ø§ Ø¨Ù‡ {config['price']} Ø§Ù…ØªÛŒØ§Ø² Ù†ÛŒØ§Ø² Ø¯Ø§Ø±ÛŒØ¯ ÙˆÙ„ÛŒ ÙÙ‚Ø· {user_points} Ø§Ù…ØªÛŒØ§Ø² Ø¯Ø§Ø±ÛŒØ¯.")
        return
    
    # Deduct points and add mine
    award_points(chat_id, user_id, -config["price"])
    add_user_resource_mine(chat_id, user_id, resource_type)
    
    await message.reply(
        f"âœ… {config['name']} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡ Ù…Ø¨Ù„Øº {config['price']} Ø§Ù…ØªÛŒØ§Ø² Ø®Ø±ÛŒØ¯Ø§Ø±ÛŒ Ø´Ø¯!\n"
        f"Ø§Ú©Ù†ÙˆÙ† {get_user_resource_mine_count(chat_id, user_id, resource_type)} {config['name']} Ø¯Ø§Ø±ÛŒØ¯.\n"
        f"Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¬Ø¯ÛŒØ¯ Ø´Ù…Ø§: {get_user_points(chat_id, user_id)} Ø§Ù…ØªÛŒØ§Ø²"
    )

async def buy_weapon(message: Message):
    chat_id = str(message.chat.id)
    user_id = str(message.author.user_id)
    content = message.content.strip().lower()
    
    weapon_id = content[5:]  # Remove "/buy_"
    
    if weapon_id not in WEAPONS_SHOP:
        await message.reply("âŒ Ø³Ù„Ø§Ø­ Ù†Ø§Ù…Ø¹ØªØ¨Ø±. Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¯Ù† Ø³Ù„Ø§Ø­â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ /shop Ø±Ø§ Ø¨Ø¨ÛŒÙ†ÛŒØ¯.")
        return
    
    weapon = WEAPONS_SHOP[weapon_id]
    user_points = get_user_points(chat_id, user_id)
    
    # Check point cost
    if user_points < weapon["price"]:
        await message.reply(f"âŒ Ø§Ù…ØªÛŒØ§Ø² Ú©Ø§ÙÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯! Ø´Ù…Ø§ Ø¨Ù‡ {weapon['price']} Ø§Ù…ØªÛŒØ§Ø² Ù†ÛŒØ§Ø² Ø¯Ø§Ø±ÛŒØ¯ ÙˆÙ„ÛŒ ÙÙ‚Ø· {user_points} Ø§Ù…ØªÛŒØ§Ø² Ø¯Ø§Ø±ÛŒØ¯.")
        return
    
    # Check resource costs
    missing_resources = []
    user_resources = get_user_resources(chat_id, user_id)
    for r_type, required in weapon.get("resources", {}).items():
        if user_resources.get(r_type, 0) < required:
            missing_resources.append(f"{RESOURCE_TYPES[r_type]['emoji']} {RESOURCE_TYPES[r_type]['name']} (Ù†ÛŒØ§Ø² {required}, Ø¯Ø§Ø±ÛŒØ¯ {user_resources.get(r_type, 0)})")
    
    if missing_resources:
        await message.reply(f"âŒ Ù…Ù†Ø§Ø¨Ø¹ Ú©Ø§ÙÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯!\n" + "\n".join(missing_resources))
        return
    
    # Deduct costs
    award_points(chat_id, user_id, -weapon["price"])
    for r_type, required in weapon.get("resources", {}).items():
        user_resources[r_type] -= required
    
    # Add to inventory
    inventory = get_user_inventory(chat_id, user_id)
    inventory[weapon_id] = inventory.get(weapon_id, 0) + 1
    save_data()
    
    # Build success message
    resource_cost = ""
    for r_type, amount in weapon.get("resources", {}).items():
        emoji = RESOURCE_TYPES[r_type]["emoji"]
        resource_cost += f"{emoji} {amount} "
    
    await message.reply(
        f"âœ… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª 1 Ø¹Ø¯Ø¯ {weapon['name']} Ø®Ø±ÛŒØ¯Ø§Ø±ÛŒ Ø´Ø¯!\n"
        f"ğŸ’µ Ù‡Ø²ÛŒÙ†Ù‡: {weapon['price']} Ø§Ù…ØªÛŒØ§Ø²\n"
        f"ğŸ“¦ Ù…Ù†Ø§Ø¨Ø¹: {resource_cost.strip()}\n"
        f"Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¬Ø¯ÛŒØ¯ Ø´Ù…Ø§: {get_user_points(chat_id, user_id)} Ø§Ù…ØªÛŒØ§Ø²"
    )

# Battle command
async def attack_player(message: Message, defender_id: str):
    chat_id = str(message.chat.id)
    attacker_id = str(message.author.user_id)
    
    if attacker_id == defender_id:
        await message.reply("âŒ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¨Ù‡ Ø®ÙˆØ¯ØªØ§Ù† Ø­Ù…Ù„Ù‡ Ú©Ù†ÛŒØ¯!")
        return
    
    # Initialize defender data if not exists
    get_user_inventory(chat_id, defender_id)
    get_user_points(chat_id, defender_id)
    
    # Get military powers
    attacker_inv = get_user_inventory(chat_id, attacker_id)
    defender_inv = get_user_inventory(chat_id, defender_id)
    
    attacker_power = calculate_military_power(attacker_inv)
    defender_power = calculate_military_power(defender_inv)
    
    if attacker_power < BATTLE_CONFIG["min_attack_power"]:
        await message.reply(f"âŒ Ø¨Ø±Ø§ÛŒ Ø­Ù…Ù„Ù‡ Ø¨Ù‡ Ø­Ø¯Ø§Ù‚Ù„ {BATTLE_CONFIG['min_attack_power']} Ù‚Ø¯Ø±Øª Ù†ÛŒØ§Ø² Ø¯Ø§Ø±ÛŒØ¯!")
        return
        
    power_diff = abs(attacker_power - defender_power) / max(attacker_power, defender_power, 1)
    if power_diff < BATTLE_CONFIG["min_power_diff"]:
        await message.reply(f"âŒ Ø¨Ø±Ø§ÛŒ Ø­Ù…Ù„Ù‡ Ø¨Ù‡ Ø­Ø¯Ø§Ù‚Ù„ {BATTLE_CONFIG['min_power_diff']*100:.0f}% Ø§Ø®ØªÙ„Ø§Ù Ù‚Ø¯Ø±Øª Ù†ÛŒØ§Ø² Ø§Ø³Øª!")
        return
    
    # Calculate battle outcome
    attacker_won = calculate_battle_outcome(attacker_power, defender_power)
    reward = random.randint(BATTLE_CONFIG["min_reward"], BATTLE_CONFIG["max_reward"])
    
    # Calculate losses
    attacker_losses = calculate_weapon_losses(attacker_inv, attacker_won)
    defender_losses = calculate_weapon_losses(defender_inv, not attacker_won)
    
    # Apply losses
    for weapon_id, loss_count in attacker_losses.items():
        attacker_inv[weapon_id] -= loss_count
        if attacker_inv[weapon_id] <= 0:
            del attacker_inv[weapon_id]
    
    for weapon_id, loss_count in defender_losses.items():
        defender_inv[weapon_id] -= loss_count
        if defender_inv[weapon_id] <= 0:
            del defender_inv[weapon_id]
    
    # Award points
    if attacker_won:
        award_points(chat_id, attacker_id, reward)
        result_title = f"âš”ï¸ {get_user_name(attacker_id)} Ù¾ÛŒØ±ÙˆØ² Ø´Ø¯! âš”ï¸"
        result_msg = f"{get_user_name(defender_id)} Ø±Ø§ Ø´Ú©Ø³Øª Ø¯Ø§Ø¯ Ùˆ {reward} Ø§Ù…ØªÛŒØ§Ø² Ú©Ø³Ø¨ Ú©Ø±Ø¯!"
    else:
        award_points(chat_id, defender_id, reward)
        result_title = f"ğŸ’¥ {get_user_name(attacker_id)} Ø´Ú©Ø³Øª Ø®ÙˆØ±Ø¯! ğŸ’¥"
        result_msg = f"{get_user_name(defender_id)} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯ÙØ§Ø¹ Ú©Ø±Ø¯ Ùˆ {reward} Ø§Ù…ØªÛŒØ§Ø² Ú©Ø³Ø¨ Ú©Ø±Ø¯!"
    
    # Update battle history
    attacker_key = get_user_key(chat_id, attacker_id)
    bot_data["battle_history"].setdefault(attacker_key, {})["last_battle"] = datetime.now().timestamp()
    save_data()
    
    # Build battle report
    report = (
        f"{result_title}\n"
        f"{result_msg}\n\n"
        f"**Ù‚Ø¯Ø±Øª Ø­Ù…Ù„Ù‡ Ú©Ù†Ù†Ø¯Ù‡**: âš”ï¸ {attacker_power}\n"
        f"**Ù‚Ø¯Ø±Øª Ù…Ø¯Ø§ÙØ¹**: âš”ï¸ {defender_power}\n\n"
    )
    
    if attacker_losses:
        report += f"**Ø­Ù…Ù„Ù‡ Ú©Ù†Ù†Ø¯Ù‡ Ø§Ø² Ø¯Ø³Øª Ø¯Ø§Ø¯**: {format_weapon_losses(attacker_losses)}\n"
    if defender_losses:
        report += f"**Ù…Ø¯Ø§ÙØ¹ Ø§Ø² Ø¯Ø³Øª Ø¯Ø§Ø¯**: {format_weapon_losses(defender_losses)}\n"
    
    report += f"\n**Ø­Ù…Ù„Ù‡ Ø¨Ø¹Ø¯ÛŒ Ù¾Ø³ Ø§Ø² 1 Ø³Ø§Ø¹Øª Ø§Ù…Ú©Ø§Ù†â€ŒÙ¾Ø°ÛŒØ± Ø§Ø³Øª.**"
    
    keyboard = MenuKeyboardMarkup()
    keyboard.add(MenuKeyboardButton("ğŸ’ Ù…ÙˆØ¬ÙˆØ¯ÛŒ"))
    keyboard.add(MenuKeyboardButton("ğŸ›’ ÙØ±ÙˆØ´Ú¯Ø§Ù‡"))
    keyboard.add(MenuKeyboardButton("ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª"))
    
    await message.reply(report, components=keyboard)

# Run the bot
client.run()